<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=3.0">
  <title>Formulário Brisanet</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 8px;
      background-color: #f8f9fa;
      min-height: 100vh;
      font-size: 14px;
    }

    .container {
      position: relative;
      width: 100%;
      max-width: 900px;
      margin: auto;
      background: white;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: visible;
      z-index: 1;
    }

    .imagem-fundo {
      width: 100%;
      height: auto;
      display: block;
      object-fit: contain;
      max-width: 100%;
      position: relative;
      z-index: 5; /* Reduzido para ficar abaixo dos campos */
    }

    .campo {
      position: absolute;
      font-size: 11px;
      padding: 2px 4px;
      border: 2px solid #007bff;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.98);
      font-family: 'Arial', sans-serif;
      min-height: 18px;
      box-sizing: border-box;
      transition: all 0.3s ease;
      z-index: 100; /* Aumentado para ficar acima da imagem */
    }

    .campo:focus {
      border-color: #0056b3;
      outline: none;
      background: white;
      z-index: 1000;
      transform: scale(1.05);
      box-shadow: 0 2px 10px rgba(0,123,255,0.3);
    }

    /* Checkboxes customizados com z-index alto */
    input[type="checkbox"].campo {
      width: 20px;
      height: 20px;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      border: 3px solid #007bff;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.98);
      position: absolute;
      margin: 0;
      padding: 0;
      transition: all 0.3s ease;
      z-index: 150; /* Z-index ainda maior para checkboxes */
    }

    input[type="checkbox"].campo:checked {
      background: #007bff;
      border-color: #0056b3;
      transform: scale(1.1);
      z-index: 150;
    }

    input[type="checkbox"].campo:checked::after {
      content: '✓';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 14px;
      font-weight: bold;
      line-height: 1;
      z-index: 151;
    }

    input[type="checkbox"].campo:hover {
      border-color: #0056b3;
      box-shadow: 0 0 8px rgba(0,123,255,0.3);
      z-index: 200;
      background: rgba(255, 255, 255, 1);
    }

    input[type="checkbox"].campo:focus {
      transform: scale(1.15);
      box-shadow: 0 0 12px rgba(0,123,255,0.6);
      outline: none;
      z-index: 1000;
    }

    /* Responsividade avançada para mobile */
    @media (max-width: 768px) {
      body {
        padding: 4px;
        font-size: 12px;
      }
      
      .container {
        width: 100%;
        margin: 0;
        border-radius: 4px;
        transform: scale(0.95);
        transform-origin: top center;
      }
      
      .campo {
        font-size: 10px;
        padding: 2px 3px;
        min-height: 16px;
        border-width: 2px;
        min-width: 30px;
        z-index: 100;
      }
      
      .campo[type="text"] {
        min-width: 50px;
      }

      input[type="checkbox"].campo {
        width: 22px;
        height: 22px;
        border-width: 2px;
        z-index: 150;
        background: rgba(255, 255, 255, 1);
      }

      input[type="checkbox"].campo:checked::after {
        font-size: 14px;
      }
      
      .button-container {
        padding: 12px 8px !important;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      
      .whatsapp-button {
        width: 100%;
        min-width: auto;
        margin: 15px 0;
        padding: 20px;
        font-size: 16px;
        border-radius: 50px;
      }
    }

    /* Para telas muito pequenas */
    @media (max-width: 480px) {
      .container {
        transform: scale(0.88);
        transform-origin: top left;
        width: 114%;
        margin-left: -7%;
      }
      
      .campo {
        font-size: 9px;
        border-width: 1.5px;
        min-height: 14px;
      }

      input[type="checkbox"].campo {
        width: 20px;
        height: 20px;
        border-width: 2px;
      }

      input[type="checkbox"].campo:checked::after {
        font-size: 12px;
      }
    }

    /* Para telas extra pequenas */
    @media (max-width: 360px) {
      .container {
        transform: scale(0.82);
        width: 122%;
        margin-left: -11%;
      }
    }

    .button-container {
      text-align: center;
      margin-top: 20px;
      padding: 24px 16px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      width: 100%;
      clear: both;
      position: relative;
      z-index: 1000;
      border-top: 1px solid #dee2e6;
    }

    .whatsapp-button {
      padding: 18px 40px;
      font-size: 18px;
      font-weight: 700;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      display: inline-block;
      min-width: 280px;
      margin: 15px auto;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 8px 25px rgba(37,211,102,0.3);
      background: linear-gradient(135deg, #25D366 0%, #20c157 50%, #1DA851 100%);
      color: white;
      position: relative;
      overflow: hidden;
      animation: pulse 2s infinite;
    }

    .whatsapp-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.6s;
    }

    .whatsapp-button:hover::before {
      left: 100%;
    }

    .whatsapp-button:hover:not(:disabled) {
      background: linear-gradient(135deg, #20c157 0%, #1DA851 50%, #128C7E 100%);
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 12px 35px rgba(37,211,102,0.4);
    }

    .whatsapp-button:active {
      transform: translateY(-1px) scale(1.02);
      box-shadow: 0 6px 20px rgba(37,211,102,0.3);
    }

    .whatsapp-button:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      animation: none;
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 8px 25px rgba(37,211,102,0.3);
      }
      50% {
        box-shadow: 0 8px 25px rgba(37,211,102,0.5), 0 0 0 10px rgba(37,211,102,0.1);
      }
      100% {
        box-shadow: 0 8px 25px rgba(37,211,102,0.3);
      }
    }

    .whatsapp-icon {
      display: inline-block;
      margin-right: 12px;
      font-size: 24px;
      animation: bounce 1s infinite;
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(-8px);
      }
      60% {
        transform: translateY(-4px);
      }
    }

    /* Para impressão */
    @media print {
      body {
        margin: 0;
        padding: 0;
        background: white;
      }
      
      .container {
        page-break-inside: avoid;
        transform: scale(0.8);
        transform-origin: top left;
        box-shadow: none;
        width: 210mm;
        max-height: 297mm;
        border-radius: 0;
      }
      
      .button-container {
        display: none;
      }

      .campo {
        border: 1px solid #000 !important;
        background: transparent !important;
      }
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      font-size: 18px;
      backdrop-filter: blur(5px);
    }

    .spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid #007bff;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Melhorias para acessibilidade */
    .campo:focus-visible {
      outline: 3px solid rgba(0,123,255,0.5);
      outline-offset: 2px;
    }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 12px 20px;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 10000;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      font-size: 14px;
      font-weight: 500;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.error {
      background: #dc3545;
    }

    /* Overlay para melhorar visibilidade dos checkboxes */
    .checkbox-overlay {
      position: absolute;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 6px;
      padding: 2px;
      z-index: 99;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <!-- Overlay de loading -->
  <div class="loading-overlay" id="loadingOverlay">
    <div style="text-align: center;">
      <div class="spinner"></div>
      <div id="loadingText">Processando...</div>
    </div>
  </div>

  <div class="container" id="formulario-pdf">
    <img src="ordem-servico.JPG" alt="Formulário Brisanet" class="imagem-fundo" id="imagemOrdem">
    
    <!-- Campos sobrepostos com posicionamento ajustado e z-index correto -->
    <input type="text" class="campo" style="top: 19%; left: 63.5%; width: 28.5%;" placeholder="Nome do cliente" id="nomeCliente">
    <input type="text" class="campo" style="top: 21.3%; left: 71.9%; width: 18.8%;" placeholder="CPF" id="cpfCliente">
    
    <!-- Serviços cancelados - linha horizontal com overlays para melhor visibilidade -->
    <div class="checkbox-overlay" style="top: 320px; left: 188px; width: 24px; height: 24px;"></div>
    <input type="checkbox" class="campo" style="top: 322px; left: 190px;" id="servico1" title="TV por assinatura">
    
    <div class="checkbox-overlay" style="top: 320px; left: 334px; width: 24px; height: 24px;"></div>
    <input type="checkbox" class="campo" style="top: 322px; left: 336px;" id="servico2" title="Ponto adicional TV">
    
    <div class="checkbox-overlay" style="top: 320px; left: 486px; width: 24px; height: 24px;"></div>
    <input type="checkbox" class="campo" style="top: 322px; left: 488px;" id="servico3" title="Internet">
    
    <div class="checkbox-overlay" style="top: 320px; left: 566px; width: 24px; height: 24px;"></div>
    <input type="checkbox" class="campo" style="top: 322px; left: 568px;" id="servico4" title="Telefonia">
    
    <!-- Equipamentos com checkboxes e campos de texto -->
    <div class="checkbox-overlay" style="top: 417px; left: 148px; width: 24px; height: 24px;"></div>
    <input type="checkbox" class="campo" style="top: 419px; left: 150px;" id="equipONU" title="ONU">
    <input type="text" class="campo" style="top: 413px; left: 218px; width: 450px;" placeholder="MAC ONU" id="macONU">
    
    <div class="checkbox-overlay" style="top: 452px; left: 201px; width: 24px; height: 24px;"></div>
    <input type="checkbox" class="campo" style="top: 454px; left: 203px;" id="equipReceptor" title="Receptor">
    <input type="text" class="campo" style="top: 450px; left: 266px; width: 401px;" placeholder="MAC Receptor" id="macReceptor">
    
    <div class="checkbox-overlay" style="top: 504px; left: 181px; width: 24px; height: 24px;"></div>
    <input type="checkbox" class="campo" style="top: 506px; left: 183px;" id="equipRoteador" title="Roteador">
    <input type="text" class="campo" style="top: 502px; left: 236px; width: 430px;" placeholder="N/S Roteador" id="nsRoteador">
    
    <div class="checkbox-overlay" style="top: 536px; left: 176px; width: 24px; height: 24px;"></div>
    <input type="checkbox" class="campo" style="top: 538px; left: 178px;" id="equipTelefone" title="Telefone">
    <input type="text" class="campo" style="top: 533px; left: 235px; width: 432px;" placeholder="N/S Telefone" id="nsTelefone">
    
    <!-- Os kits estão completos -->
    <input type="text" class="campo" style="top: 593px; left: 153px; width: 300px;" placeholder="Os kits estão completos" id="kitsTexto">
    <div class="checkbox-overlay" style="top: 570px; left: 313px; width: 24px; height: 24px;"></div>
    <input type="checkbox" class="campo" style="top: 572px; left: 315px;" id="kitsCompletos" title="Sim">
    <div class="checkbox-overlay" style="top: 570px; left: 370px; width: 24px; height: 24px;"></div>
    <input type="checkbox" class="campo" style="top: 572px; left: 372px;" id="kitsIncompletos" title="Não">
    
    <!-- Os Equipamentos estão em bom estado de conservação -->
    <input type="text" class="campo" style="top: 693px; left: 149px; width: 300px;" placeholder="Os Equipamentos estão em bom estado" id="estadoTexto">
    <div class="checkbox-overlay" style="top: 660px; left: 530px; width: 24px; height: 24px;"></div>
    <input type="checkbox" class="campo" style="top: 662px; left: 532px;" id="bomEstado" title="Sim">
    <div class="checkbox-overlay" style="top: 660px; left: 590px; width: 24px; height: 24px;"></div>
    <input type="checkbox" class="campo" style="top: 662px; left: 592px;" id="mauEstado" title="Não">
    
    <!-- Informações finais -->
    <input type="text" class="campo" style="top: 65.3%; left: 35%; width: 37.5%;" placeholder="Protocolo de atendimento" id="protocolo">
    <input type="text" class="campo" style="top: 69.3%; left: 35%; width: 37.5%;" placeholder="Técnico responsável" id="tecnico">
    <input type="text" class="campo" style="top: 73.5%; left: 35%; width: 37.5%;" placeholder="Responsável pela devolução" id="responsavel">
    <input type="text" class="campo" style="top: 77.3%; left: 35%; width: 37.5%;" placeholder="Grau de parentesco" id="parentesco">
    
    <!-- Local e data -->
    <input type="text" class="campo" style="top: 82.4%; left: 27.1%; width: 10%;" placeholder="Cidade" id="cidade" value="Fortaleza">
    <input type="text" class="campo" style="top: 82.4%; left: 39%; width: 4.4%;" placeholder="Dia" id="dia">
    <input type="text" class="campo" style="top: 82.4%; left: 46.3%; width: 18.8%;" placeholder="Mês" id="mes">
    <input type="text" class="campo" style="top: 82.4%; left: 69.4%; width: 7.9%;" placeholder="Ano" id="ano">
  </div>
  
  <!-- Botão WhatsApp animado -->
  <div class="button-container">
    <button onclick="enviarWhatsApp()" class="whatsapp-button" id="btnWhatsApp">
      <span class="whatsapp-icon">📱</span>
      Enviar via WhatsApp
    </button>
  </div>

  <script>
    // Detectar dispositivo móvel de forma mais precisa
    function isMobile() {
      return window.innerWidth <= 768 || 
             /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
             (navigator.maxTouchPoints && navigator.maxTouchPoints > 2);
    }

    // Sistema de toast notifications
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 3000);
    }

    // Loading otimizado
    function showLoading(text = 'Processando...') {
      const overlay = document.getElementById('loadingOverlay');
      const loadingText = document.getElementById('loadingText');
      loadingText.textContent = text;
      overlay.style.display = 'flex';
    }

    function hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      overlay.style.display = 'none';
    }

    // Inicialização melhorada
    document.addEventListener('DOMContentLoaded', function() {
      otimizarParaMobile();
      configurarCheckboxesExclusivos();
      adicionarEventosCheckboxes();
      
      // Garantir que checkboxes fiquem visíveis
      setTimeout(() => {
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => {
          cb.style.zIndex = '150';
          cb.style.position = 'absolute';
        });
      }, 100);
    });

    // Adicionar eventos específicos para checkboxes
    function adicionarEventosCheckboxes() {
      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      
      checkboxes.forEach(checkbox => {
        // Evento de clique com propagação
        checkbox.addEventListener('click', function(e) {
          e.stopPropagation();
          console.log(`Checkbox ${this.id} clicado:`, this.checked);
          
          // Feedback visual
          this.style.transform = this.checked ? 'scale(1.2)' : 'scale(1.1)';
          setTimeout(() => {
            this.style.transform = '';
          }, 200);
          
          // Toast de feedback
          const status = this.checked ? 'selecionado' : 'desmarcado';
          showToast(`✅ ${this.title || 'Item'} ${status}`, 'success');
        });

        // Evento de mudança
        checkbox.addEventListener('change', function(e) {
          console.log(`Checkbox ${this.id} mudou para:`, this.checked);
        });

        // Hover para melhor feedback
        checkbox.addEventListener('mouseenter', function() {
          this.style.zIndex = '200';
          this.style.boxShadow = '0 0 12px rgba(0,123,255,0.5)';
        });

        checkbox.addEventListener('mouseleave', function() {
          this.style.zIndex = '150';
          this.style.boxShadow = '';
        });
      });
    }

    // Ajustes específicos para mobile
    function otimizarParaMobile() {
      if (isMobile()) {
        const campos = document.querySelectorAll('.campo');
        
        campos.forEach((campo, index) => {
          // Melhorar responsividade
          campo.style.backgroundColor = 'rgba(255, 255, 255, 0.98)';
          campo.style.border = '2px solid #007bff';
          
          if (campo.type === 'text') {
            campo.style.minWidth = '70px';
          }

          // Garantir z-index para checkboxes
          if (campo.type === 'checkbox') {
            campo.style.zIndex = '150';
            campo.style.background = 'rgba(255, 255, 255, 1)';
          }

          // Eventos otimizados para touch
          campo.addEventListener('focus', function() {
            this.style.transform = 'scale(1.1)';
            this.style.zIndex = '1000';
            
            // Scroll suave para o campo focado
            setTimeout(() => {
              this.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center',
                inline: 'nearest'
              });
            }, 100);
          });
          
          campo.addEventListener('blur', function() {
            this.style.transform = '';
            this.style.zIndex = campo.type === 'checkbox' ? '150' : '100';
          });
        });
        
        // Adicionar meta tag para zoom
        const metaViewport = document.querySelector('meta[name="viewport"]');
        if (metaViewport) {
          metaViewport.content = 'width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=3.0, minimum-scale=0.5';
        }
      }
    }

    // Lógica melhorada para checkboxes mutuamente exclusivos
    function configurarCheckboxesExclusivos() {
      // Kits completos/incompletos
      const kitsCompletos = document.getElementById('kitsCompletos');
      const kitsIncompletos = document.getElementById('kitsIncompletos');
      
      kitsCompletos.addEventListener('change', function() {
        if (this.checked) {
          kitsIncompletos.checked = false;
          console.log('Kits marcados como completos');
        }
      });
      
      kitsIncompletos.addEventListener('change', function() {
        if (this.checked) {
          kitsCompletos.checked = false;
          console.log('Kits marcados como incompletos');
        }
      });
      
      // Estado dos equipamentos
      const bomEstado = document.getElementById('bomEstado');
      const mauEstado = document.getElementById('mauEstado');
      
      bomEstado.addEventListener('change', function() {
        if (this.checked) {
          mauEstado.checked = false;
          console.log('Equipamentos em bom estado');
        }
      });
      
      mauEstado.addEventListener('change', function() {
        if (this.checked) {
          bomEstado.checked = false;
          console.log('Equipamentos em mau estado');
        }
      });
    }

    // WhatsApp melhorado com debug dos checkboxes
    async function enviarWhatsApp() {
      showLoading('🚀 Preparando WhatsApp...');
      
      try {
        // Dados básicos
        const nomeCliente = document.getElementById('nomeCliente').value || 'Cliente';
        const cpf = document.getElementById('cpfCliente').value || 'N/A';
        const protocolo = document.getElementById('protocolo').value || `OS${Date.now()}`;
        const tecnico = document.getElementById('tecnico').value || 'N/A';
        const responsavel = document.getElementById('responsavel').value || 'N/A';
        const parentesco = document.getElementById('parentesco').value || 'N/A';
        const cidade = document.getElementById('cidade').value || 'Fortaleza';
        
        // Debug: verificar estado dos checkboxes
        console.log('🔍 Debug Checkboxes:');
        console.log('Servico 1:', document.getElementById('servico1').checked);
        console.log('Servico 2:', document.getElementById('servico2').checked);
        console.log('Servico 3:', document.getElementById('servico3').checked);
        console.log('Servico 4:', document.getElementById('servico4').checked);
        console.log('Kits Completos:', document.getElementById('kitsCompletos').checked);
        console.log('Bom Estado:', document.getElementById('bomEstado').checked);
        
        // Coletar serviços cancelados
        const servicos = [];
        if (document.getElementById('servico1').checked) servicos.push('📺 TV por assinatura');
        if (document.getElementById('servico2').checked) servicos.push('📺 Ponto adicional TV');
        if (document.getElementById('servico3').checked) servicos.push('🌐 Internet');
        if (document.getElementById('servico4').checked) servicos.push('📞 Telefonia');
        
        // Coletar equipamentos devolvidos
        const equipamentos = [];
        if (document.getElementById('equipONU').checked) {
          const mac = document.getElementById('macONU').value;
          equipamentos.push(`📡 ONU${mac ? ` (MAC: ${mac})` : ''}`);
        }
        if (document.getElementById('equipReceptor').checked) {
          const mac = document.getElementById('macReceptor').value;
          equipamentos.push(`📺 Receptor${mac ? ` (MAC: ${mac})` : ''}`);
        }
        if (document.getElementById('equipRoteador').checked) {
          const ns = document.getElementById('nsRoteador').value;
          equipamentos.push(`🌐 Roteador${ns ? ` (N/S: ${ns})` : ''}`);
        }
        if (document.getElementById('equipTelefone').checked) {
          const ns = document.getElementById('nsTelefone').value;
          equipamentos.push(`📞 Telefone${ns ? ` (N/S: ${ns})` : ''}`);
        }
        
        // Status dos kits e equipamentos
        let statusKits = '❓ Não informado';
        if (document.getElementById('kitsCompletos').checked) statusKits = '✅ Completos';
        if (document.getElementById('kitsIncompletos').checked) statusKits = '❌ Incompletos';
        
        let statusEquip = '❓ Não informado';
        if (document.getElementById('bomEstado').checked) statusEquip = '✅ Bom estado';
        if (document.getElementById('mauEstado').checked) statusEquip = '⚠️ Mau estado';
        
        // Criar mensagem completa
        let mensagem = 
          `🌐 *BRISANET - ORDEM DE SERVIÇO*\n` +
          `═══════════════════════════════\n\n` +
          
          `👤 *DADOS DO CLIENTE*\n` +
          `• Nome: ${nomeCliente}\n` +
          `• CPF: ${cpf}\n` +
          `• Protocolo: ${protocolo}\n\n` +
          
          `👨‍🔧 *TÉCNICO RESPONSÁVEL*\n` +
          `• ${tecnico}\n\n` +
          
          `👥 *RESPONSÁVEL PELA DEVOLUÇÃO*\n` +
          `• ${responsavel}\n` +
          `• Parentesco: ${parentesco}\n\n`;
          
        // Adicionar serviços cancelados se houver
        if (servicos.length > 0) {
          mensagem += `❌ *SERVIÇOS CANCELADOS*\n${servicos.map(s => `• ${s}`).join('\n')}\n\n`;
        }
        
        // Adicionar equipamentos devolvidos se houver
        if (equipamentos.length > 0) {
          mensagem += `📦 *EQUIPAMENTOS DEVOLVIDOS*\n${equipamentos.join('\n')}\n\n`;
        }
        
        mensagem +=
          `📋 *STATUS DOS KITS E EQUIPAMENTOS*\n` +
          `• Kits: ${statusKits}\n` +
          `• Equipamentos: ${statusEquip}\n\n` +
          
          `📍 *LOCAL E DATA*\n` +
          `• ${cidade}, ${document.getElementById('dia').value || 'DD'}/${document.getElementById('mes').value || 'Mês'}/${document.getElementById('ano').value || 'AAAA'}\n\n` +
          
          `✅ *Ordem de serviço processada com sucesso!*\n\n` +
          `🔥 *BRISANET* - _Conectando você ao futuro_`;

        const mensagemEncoded = encodeURIComponent(mensagem);
        
        hideLoading();

        // Abrir WhatsApp com tratamento por plataforma
        let whatsappURL;
        
        if (isMobile()) {
          // Tentar app nativo primeiro
          whatsappURL = `whatsapp://send?text=${mensagemEncoded}`;
          
          // Criar link invisível para tentar abrir o app
          const link = document.createElement('a');
          link.href = whatsappURL;
          link.target = '_blank';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          // Fallback para WhatsApp Web após 2 segundos
          setTimeout(() => {
            const webURL = `https://api.whatsapp.com/send?text=${mensagemEncoded}`;
            window.open(webURL, '_blank');
          }, 2000);
          
        } else {
          // Desktop: WhatsApp Web direto
          whatsappURL = `https://web.whatsapp.com/send?text=${mensagemEncoded}`;
          window.open(whatsappURL, '_blank', 'width=1000,height=700');
        }

        // Feedback de sucesso
        showToast('📱 WhatsApp aberto! Verifique se todos os dados estão corretos!', 'success');
        
        // Animação de sucesso no botão
        const btnWhatsApp = document.getElementById('btnWhatsApp');
        const originalHTML = btnWhatsApp.innerHTML;
        const originalBG = btnWhatsApp.style.background;
        
        btnWhatsApp.style.animation = 'none';
        btnWhatsApp.style.background = 'linear-gradient(135deg, #28a745 0%, #20c157 100%)';
        btnWhatsApp.innerHTML = '<span style="animation: bounce 0.5s;">✅</span> Enviado com sucesso!';
        
        setTimeout(() => {
          btnWhatsApp.innerHTML = originalHTML;
          btnWhatsApp.style.background = originalBG;
          btnWhatsApp.style.animation = 'pulse 2s infinite';
        }, 4000);
        
        console.log('✅ Mensagem preparada:', mensagem);
        
      } catch (error) {
        console.error('❌ Erro WhatsApp:', error);
        hideLoading();
        showToast('❌ Erro ao preparar WhatsApp. Tente novamente.', 'error');
      }
    }

    // Preparar para PDF com melhor rendering
    function prepararParaPDF() {
      const container = document.getElementById('formulario-pdf');
      const inputs = container.querySelectorAll('input');
      const substituidos = [];

      inputs.forEach(input => {
        const span = document.createElement('span');
        
        if (input.type === 'checkbox') {
          span.textContent = input.checked ? '☑' : '☐';
          span.style.fontSize = '16px';
          span.style.fontWeight = 'bold';
          span.style.color = input.checked ? '#007bff' : '#666';
          span.style.textAlign = 'center';
          span.style.lineHeight = '16px';
        } else {
          const valor = input.value || '_'.repeat(Math.max(20, Math.floor(parseInt(input.style.width) / 8)));
          span.textContent = valor;
          span.style.fontSize = '11px';
          span.style.fontWeight = '500';
          span.style.color = input.value ? '#000' : '#999';
        }
        
        // Copiar estilos de posicionamento
        span.style.position = 'absolute';
        span.style.top = input.style.top;
        span.style.left = input.style.left;
        span.style.width = input.style.width;
        span.style.fontFamily = 'Arial, sans-serif';
        span.style.padding = '2px';
        span.style.border = 'none';
        span.style.background = 'transparent';
        span.style.lineHeight = input.type === 'checkbox' ? '16px' : '1.2';
        span.style.display = 'inline-block';
        span.style.overflow = 'hidden';
        span.style.whiteSpace = 'nowrap';
        span.style.textOverflow = 'ellipsis';
        
        container.appendChild(span);
        substituidos.push({ original: input, substituto: span });
        input.style.display = 'none';
      });

      return substituidos;
    }

    function restaurarInputs(substituidos) {
      substituidos.forEach(({ original, substituto }) => {
        substituto.remove();
        original.style.display = '';
      });
    }

    // Gerar PDF otimizado
    async function gerarPDF() {
      showLoading('Gerando PDF...');
      
      try {
        const container = document.getElementById('formulario-pdf');
        const substituidos = prepararParaPDF();

        const nomeCliente = document.getElementById('nomeCliente').value || 'Cliente';
        const protocolo = document.getElementById('protocolo').value || new Date().getTime();

        const opt = {
          margin: [10, 10, 10, 10],
          filename: `brisanet-os-${nomeCliente.replace(/\s+/g, '-')}-${protocolo}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { 
            scale: 2.5,
            useCORS: true,
            allowTaint: true,
            backgroundColor: '#ffffff',
            scrollX: 0,
            scrollY: 0,
            windowWidth: container.scrollWidth,
            windowHeight: container.scrollHeight,
            letterRendering: true
          },
          jsPDF: { 
            unit: 'mm', 
            format: 'a4', 
            orientation: 'portrait',
            compress: true
          }
        };

        await html2pdf().set(opt).from(container).save();
        
        showToast('PDF gerado com sucesso!', 'success');
        hideLoading();
        
      } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        showToast('Erro ao gerar PDF. Tente novamente.', 'error');
        hideLoading();
      } finally {
        setTimeout(() => {
          try {
            restaurarInputs(substituidos);
          } catch (e) {
            console.warn('Erro ao restaurar inputs:', e);
          }
        }, 1000);
      }
    }

    // Imprimir otimizado
    function imprimirFormulario() {
      showLoading('Preparando impressão...');
      
      const container = document.getElementById('formulario-pdf');
      const substituidos = prepararParaPDF();

      setTimeout(() => {
        hideLoading();
        window.print();
        
        setTimeout(() => {
          restaurarInputs(substituidos);
        }, 2000);
      }, 800);
    }
  </script>
</body>
</html>
