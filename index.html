<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.5, maximum-scale=3.0">
  <title>Formulário Brisanet</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 8px;
      background-color: #f5f5f5;
      min-height: 100vh;
      -webkit-text-size-adjust: none;
      text-size-adjust: none;
    }

    .container {
      position: relative;
      width: 100%;
      max-width: 800px;
      margin: auto;
      background: white;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      overflow: visible;
      border-radius: 8px;
    }

    .imagem-fundo {
      width: 100%;
      height: auto;
      display: block;
      object-fit: contain;
      border-radius: 8px 8px 0 0;
    }

    .campo {
      position: absolute;
      font-size: 11px;
      padding: 2px 4px;
      border: 2px solid #007bff;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.95);
      font-family: Arial, sans-serif;
      min-height: 18px;
      box-sizing: border-box;
      transition: all 0.3s ease;
    }

    .campo[type="checkbox"] {
      width: 14px;
      height: 14px;
      min-height: 14px;
      padding: 0;
      margin: 0;
      transform: scale(0.9);
      cursor: pointer;
      accent-color: #007bff;
    }

    .campo:focus {
      border-color: #0056b3;
      outline: none;
      background: white;
      z-index: 1000;
      box-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
      transform: scale(1.05);
    }

    .campo:active {
      transform: scale(0.98);
    }

    /* Otimizações para mobile */
    @media (max-width: 768px) {
      body {
        padding: 4px;
        background-color: #f8f9fa;
      }
      
      .container {
        width: 100%;
        margin: 0;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      }
      
      .campo {
        font-size: 12px;
        padding: 3px 5px;
        min-height: 22px;
        min-width: 30px;
        border-width: 2px;
        font-weight: 500;
      }
      
      .campo[type="text"] {
        min-width: 50px;
      }
      
      .campo[type="checkbox"] {
        width: 16px;
        height: 16px;
        min-height: 16px;
        transform: scale(1.0);
      }
      
      .campo:focus {
        transform: scale(1.1);
        z-index: 1001;
        border-color: #007bff;
        box-shadow: 0 0 12px rgba(0, 123, 255, 0.4);
      }
      
      .button-container {
        padding: 20px 15px !important;
        margin-top: 15px;
      }
      
      .whatsapp-button {
        width: 100%;
        min-width: auto;
        margin: 0;
        padding: 18px 25px;
        font-size: 18px;
        font-weight: 600;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
      }
    }

    /* Para telas muito pequenas */
    @media (max-width: 480px) {
      .container {
        border-radius: 8px;
      }
      
      .campo {
        font-size: 11px;
        padding: 2px 4px;
        min-height: 20px;
        border-width: 2px;
      }

      .campo:focus {
        font-size: 13px;
        padding: 4px 6px;
        border-width: 3px;
      }

      .whatsapp-button {
        font-size: 16px;
        padding: 16px 20px;
      }
    }

    .button-container {
      text-align: center;
      margin-top: 25px;
      padding: 25px 20px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      width: 100%;
      clear: both;
      position: relative;
      z-index: 1000;
      border-radius: 0 0 8px 8px;
    }

    .whatsapp-button {
      padding: 14px 30px;
      font-size: 16px;
      background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-block;
      min-width: 250px;
      margin: 5px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: relative;
      overflow: hidden;
    }

    .whatsapp-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .whatsapp-button:hover::before {
      left: 100%;
    }

    .whatsapp-button:hover:not(:disabled) {
      background: linear-gradient(135deg, #1DA851 0%, #0F6B47 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(37, 211, 102, 0.4);
    }

    .whatsapp-button:active {
      transform: translateY(0);
    }

    .whatsapp-button:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Para garantir que tudo fique em uma página no PDF */
    @media print {
      body {
        margin: 0;
        padding: 0;
        background: white;
      }
      
      .container {
        page-break-inside: avoid;
        transform: scale(0.75);
        transform-origin: top left;
        box-shadow: none;
        width: 210mm;
        max-height: 297mm;
        border-radius: 0;
      }
      
      .button-container {
        display: none;
      }
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      font-size: 18px;
      backdrop-filter: blur(5px);
    }

    .loading-content {
      text-align: center;
      background: rgba(255, 255, 255, 0.1);
      padding: 30px;
      border-radius: 15px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #25D366;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 16px;
      font-weight: 500;
      margin-top: 10px;
    }

    /* Melhorias de acessibilidade */
    .campo:focus {
      outline: 3px solid rgba(0, 123, 255, 0.3);
      outline-offset: 2px;
    }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #28a745;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      z-index: 10000;
      font-weight: 500;
      opacity: 0;
      transition: all 0.3s ease;
    }

    .toast.show {
      opacity: 1;
    }

    .toast.error {
      background: #dc3545;
    }
  </style>
</head>
<body>
  <!-- Overlay de loading -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <div id="loadingText">Processando...</div>
      <div class="loading-text">Aguarde um momento</div>
    </div>
  </div>

  <div class="container" id="formulario-pdf">
    <img src="ordem-servico.JPG" alt="Imagem da Ordem de Serviço" class="imagem-fundo" id="imagemOrdem">
    
    <!-- Campos sobrepostos -->
    <input type="text" class="campo" style="top: 283px; left: 588px; width: 260px;" placeholder="Nome do cliente" id="nomeCliente">
    <input type="text" class="campo" style="top: 313px; left: 695px; width: 120px;" placeholder="CPF" id="cpfCliente">
    
    <!-- Serviços cancelados -->
    <input type="checkbox" class="campo" style="top: 382px; left: 220px;" id="servico1" title="TV por assinatura">
    <input type="checkbox" class="campo" style="top: 382px; left: 407px;" id="servico2" title="Ponto adicional TV">
    <input type="checkbox" class="campo" style="top: 382px; left: 574px;" id="servico3" title="Internet">
    <input type="checkbox" class="campo" style="top: 382px; left: 690px;" id="servico4" title="Telefonia">
    
    <!-- Equipamentos -->
    <input type="checkbox" class="campo" style="top: 492px; left: 185px;" id="equipONU" title="ONU">
    <input type="text" class="campo" style="top: 492px; left: 250px; width: 540px;" placeholder="MAC ONU" id="macONU">
    
    <input type="checkbox" class="campo" style="top: 537px; left: 246px;" id="equipReceptor" title="Receptores">
    <input type="text" class="campo" style="top: 537px; left: 310px; width: 480px;" placeholder="MAC Receptores" id="macReceptor">
    
    <input type="checkbox" class="campo" style="top: 598px; left: 215px;" id="equipRoteador" title="Roteador">
    <input type="text" class="campo" style="top: 598px; left: 280px; width: 510px;" placeholder="N/S Roteador" id="nsRoteador">
    
    <input type="checkbox" class="campo" style="top: 635px; left: 215px;" id="equipTelefone" title="Telefone">
    <input type="text" class="campo" style="top: 635px; left: 280px; width: 510px;" placeholder="N/S Telefone" id="nsTelefone">
    
    <!-- Os kits estão completos -->
    <input type="checkbox" class="campo" style="top: 670px; left: 363px;" id="kitsCompletos" title="Sim">
    <input type="checkbox" class="campo" style="top: 670px; left: 431px;" id="kitsIncompletos" title="Não">
    <input type="text" class="campo" style="top: 702px; left: 148px; width: 640px;" placeholder="Observações sobre os kits" id="obsKits">
    
    <!-- Os Equipamentos estão em bom estado de conservação -->
    <input type="checkbox" class="campo" style="top: 774px; left: 615px;" id="bomEstado" title="Sim">
    <input type="checkbox" class="campo" style="top: 774px; left: 683px;" id="mauEstado" title="Não">
    <input type="text" class="campo" style="top: 818px; left: 133px; width: 660px;" placeholder="Observações sobre estado dos equipamentos" id="obsEstado">
    
    <!-- Informações finais -->
    <input type="text" class="campo" style="top: 927px; left: 415px; width: 350px;" placeholder="Protocolo de atendimento" id="protocolo">
    <input type="text" class="campo" style="top: 983px; left: 382px; width: 380px;" placeholder="Técnico responsável pelo recolhimento" id="tecnico">
    <input type="text" class="campo" style="top: 1042px; left: 415px; width: 350px;" placeholder="Responsável pela devolução" id="responsavel">
    <input type="text" class="campo" style="top: 1099px; left: 436px; width: 300px;" placeholder="Grau de parentesco" id="parentesco">
    
    <!-- Local e data -->
    <input type="text" class="campo" style="top: 1159px; left: 248px; width: 100px;" placeholder="Cidade" id="cidade">
    <input type="text" class="campo" style="top: 1159px; left: 388px; width: 50px;" placeholder="Dia" id="dia">
    <input type="text" class="campo" style="top: 1159px; left: 516px; width: 120px;" placeholder="Mês" id="mes">
    <input type="text" class="campo" style="top: 1159px; left: 678px; width: 80px;" placeholder="Ano" id="ano">
  </div>
  
  <!-- Botão WhatsApp -->
  <div class="button-container">
    <button onclick="enviarWhatsApp()" class="whatsapp-button" id="btnWhatsApp">
      📱 Enviar via WhatsApp
    </button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script>
    // Detectar se é dispositivo móvel
    function isMobile() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
             (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1) ||
             window.innerWidth <= 768;
    }

    // Detectar sistema operacional
    function getOS() {
      const userAgent = navigator.userAgent || navigator.vendor || window.opera;
      
      if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
        return 'iOS';
      }
      
      if (/android/i.test(userAgent)) {
        return 'Android';
      }
      
      return 'Other';
    }

    // Toast notification
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type === 'error' ? 'error' : ''}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('show');
      }, 100);
      
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 300);
      }, 3000);
    }

    // Mostrar loading
    function showLoading(text = 'Processando...') {
      const overlay = document.getElementById('loadingOverlay');
      const loadingText = document.getElementById('loadingText');
      loadingText.textContent = text;
      overlay.style.display = 'flex';
      
      // Vibrar no mobile se disponível
      if (navigator.vibrate && isMobile()) {
        navigator.vibrate(100);
      }
    }

    // Esconder loading
    function hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      overlay.style.display = 'none';
    }

    // Melhorar experiência mobile
    function otimizarParaMobile() {
      if (isMobile()) {
        const campos = document.querySelectorAll('.campo');
        
        campos.forEach(campo => {
          // Melhorar visibilidade
          campo.style.backgroundColor = 'rgba(255, 255, 255, 0.98)';
          campo.style.border = '2px solid #007bff';
          
          // Eventos de foco otimizados para mobile
          campo.addEventListener('focus', function() {
            this.style.zIndex = '1001';
            
            // Scroll suave para o campo
            setTimeout(() => {
              this.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center',
                inline: 'center'
              });
            }, 100);
            
            // Zoom mais suave
            this.style.transition = 'all 0.3s ease';
          });
          
          campo.addEventListener('blur', function() {
            this.style.zIndex = '';
            this.style.transition = 'all 0.3s ease';
          });

          // Melhorar experiência touch
          campo.addEventListener('touchstart', function() {
            this.style.borderColor = '#0056b3';
          });
        });

        // Melhorar botão WhatsApp para mobile
        const btnWhatsApp = document.getElementById('btnWhatsApp');
        btnWhatsApp.addEventListener('touchstart', function() {
          this.style.transform = 'translateY(-1px) scale(0.98)';
        });
        
        btnWhatsApp.addEventListener('touchend', function() {
          this.style.transform = '';
        });
      }
    }

    function prepararParaPDF() {
      const container = document.getElementById('formulario-pdf');
      const inputs = container.querySelectorAll('input');
      const substituidos = [];

      inputs.forEach(input => {
        const span = document.createElement('span');
        
        if (input.type === 'checkbox') {
          span.textContent = input.checked ? '✓' : '☐';
          span.style.fontSize = '16px';
          span.style.fontWeight = 'bold';
          span.style.color = input.checked ? '#007bff' : '#ccc';
        } else {
          span.textContent = input.value || '_'.repeat(Math.max(10, (input.style.width.replace('px', '') / 8)));
          span.style.fontSize = '12px';
          span.style.fontWeight = 'bold';
        }
        
        span.style.position = 'absolute';
        span.style.top = input.style.top;
        span.style.left = input.style.left;
        span.style.width = input.style.width;
        span.style.color = span.style.color || '#000';
        span.style.fontFamily = 'Arial, sans-serif';
        span.style.padding = '2px';
        span.style.border = 'none';
        span.style.background = 'transparent';
        span.style.lineHeight = '1.2';
        span.style.display = 'inline-block';
        span.style.whiteSpace = 'nowrap';
        span.style.overflow = 'hidden';
        
        container.appendChild(span);
        substituidos.push({ original: input, substituto: span });
        input.style.display = 'none';
      });

      return substituidos;
    }

    function restaurarInputs(substituidos) {
      substituidos.forEach(({ original, substituto }) => {
        substituto.remove();
        original.style.display = '';
      });
    }

    async function gerarPDFParaWhatsApp() {
      const container = document.getElementById('formulario-pdf');
      const substituidos = prepararParaPDF();
      const nomeCliente = document.getElementById('nomeCliente').value || 'cliente';

      const opt = {
        margin: 10,
        filename: `ordem-servico-${nomeCliente.replace(/[^a-zA-Z0-9]/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { 
          scale: 2.5,
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#ffffff',
          scrollX: 0,
          scrollY: 0,
          windowWidth: container.scrollWidth,
          windowHeight: container.scrollHeight,
          width: container.scrollWidth,
          height: container.scrollHeight
        },
        jsPDF: { 
          unit: 'mm', 
          format: 'a4', 
          orientation: 'portrait' 
        }
      };

      try {
        await html2pdf().set(opt).from(container).save();
        restaurarInputs(substituidos);
        return true;
      } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        restaurarInputs(substituidos);
        return false;
      }
    }

    function enviarWhatsApp() {
      // Validação básica
      const nomeCliente = document.getElementById('nomeCliente').value;
      if (!nomeCliente.trim()) {
        showToast('Por favor, preencha o nome do cliente', 'error');
        document.getElementById('nomeCliente').focus();
        return;
      }

      showLoading('Gerando PDF e preparando envio...');
      
      const protocolo = document.getElementById('protocolo').value || 'Não informado';
      const tecnico = document.getElementById('tecnico').value || 'Não informado';
      const cidade = document.getElementById('cidade').value || 'Não informada';
      
      // Preparar mensagem do WhatsApp
      const mensagem = encodeURIComponent(
        `📋 *ORDEM DE SERVIÇO BRISANET*\n\n` +
        `👤 *Cliente:* ${nomeCliente}\n` +
        `📄 *Protocolo:* ${protocolo}\n` +
        `👨‍🔧 *Técnico:* ${tecnico}\n` +
        `🌍 *Cidade:* ${cidade}\n` +
        `📅 *Data:* ${new Date().toLocaleDateString('pt-BR', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        })}\n` +
        `🕐 *Hora:* ${new Date().toLocaleTimeString('pt-BR', { 
          hour: '2-digit', 
          minute: '2-digit' 
        })}\n\n` +
        `✅ Ordem de serviço preenchida e enviada automaticamente.\n` +
        `📎 PDF anexado com todos os detalhes.\n\n` +
        `*🌐 Brisanet - Conectando você ao futuro*`
      );

      // Gerar PDF e depois abrir WhatsApp
      gerarPDFParaWhatsApp().then(pdfGerado => {
        setTimeout(() => {
          hideLoading();
          
          if (pdfGerado) {
            showToast('PDF gerado com sucesso!');
            
            // Abrir WhatsApp após pequeno delay
            setTimeout(() => {
              abrirWhatsApp(mensagem);
            }, 1000);
            
          } else {
            showToast('Erro ao gerar PDF. Tente novamente.', 'error');
          }
        }, 1500);
      });
    }

    function abrirWhatsApp(mensagem) {
      const os = getOS();
      let whatsappURL;
      let fallbackURL;
      
      if (os === 'iOS') {
        whatsappURL = `whatsapp://send?text=${mensagem}`;
        fallbackURL = `https://wa.me/?text=${mensagem}`;
      } else if (os === 'Android') {
        whatsappURL = `intent://send?text=${mensagem}#Intent;package=com.whatsapp;scheme=whatsapp;launchFlags=0x10000000;end`;
        fallbackURL = `https://wa.me/?text=${mensagem}`;
      } else {
        whatsappURL = `https://web.whatsapp.com/send?text=${mensagem}`;
        fallbackURL = null;
      }

      if (isMobile() && fallbackURL) {
        // Tentar abrir app nativo primeiro
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = whatsappURL;
        document.body.appendChild(iframe);
        
        // Fallback para navegador após 2 segundos
        setTimeout(() => {
          document.body.removeChild(iframe);
          window.open(fallbackURL, '_blank');
          
          // Mostrar instruções
          setTimeout(() => {
            const instrucoes = isMobile() ? 
              '📱 WhatsApp aberto!\n\n✅ PDF baixado automaticamente\n📎 Anexe o arquivo no chat\n💬 Mensagem pronta para envio!' :
              '💻 WhatsApp Web aberto!\n\n✅ PDF baixado\n📎 Anexe o arquivo manualmente\n💬 Mensagem pronta!';
            
            showToast('Instruções enviadas para o WhatsApp!');
            console.log(instrucoes);
          }, 1000);
        }, 2000);
        
      } else {
        window.open(whatsappURL, '_blank');
        showToast('WhatsApp aberto! Anexe o PDF baixado.');
      }
    }

    // Auto-preencher data atual
    function preencherDataAtual() {
      const hoje = new Date();
      const dia = String(hoje.getDate()).padStart(2, '0');
      const meses = [
        'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
      ];
      const mes = meses[hoje.getMonth()];
      const ano = hoje.getFullYear();

      document.getElementById('dia').value = dia;
      document.getElementById('mes').value = mes;
      document.getElementById('ano').value = ano;
      document.getElementById('cidade').value = 'Fortaleza'; // Valor padrão baseado na localização
    }

    // Inicializar quando a página carregar
    document.addEventListener('DOMContentLoaded', function() {
      otimizarParaMobile();
      preencherDataAtual();
      
      // Verificar se o html2pdf foi carregado
      if (typeof html2pdf === 'undefined') {
        console.error('html2pdf não foi carregado corretamente');
        showToast('Erro ao carregar componentes. Recarregue a página.', 'error');
      } else {
        showToast('Formulário carregado com sucesso!');
      }

      // Adicionar eventos de teclado para melhor navegação
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.target.classList.contains('campo')) {
          const campos = Array.from(document.querySelectorAll('.campo[type="text"]'));
          const currentIndex = campos.indexOf(e.target);
          if (currentIndex < campos.length - 1) {
            campos[currentIndex + 1].focus();
          }
        }
      });
    });

    // Prevenir zoom no iOS quando focar em inputs
    if (getOS() === 'iOS') {
      document.addEventListener('touchstart', function() {}, {passive: true});
    }
  </script>
</body>
</html>
