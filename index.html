<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formul√°rio Brisanet</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
      background-color: #f5f5f5;
      min-height: 100vh;
    }

    .container {
      position: relative;
      width: 100%;
      max-width: 800px;
      margin: auto;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      overflow: visible;
    }

    .imagem-fundo {
      width: 100%;
      height: auto;
      display: block;
      object-fit: contain;
    }

    .campo {
      position: absolute;
      font-size: 12px;
      padding: 1px 2px;
      border: 1px solid #007bff;
      border-radius: 3px;
      background: rgba(255, 255, 255, 0.95);
      font-family: Arial, sans-serif;
      min-height: 16px;
      box-sizing: border-box;
    }

    .campo[type="checkbox"] {
      width: 12px;
      height: 12px;
      min-height: 12px;
      padding: 0;
      margin: 0;
      transform: scale(0.8);
      cursor: pointer;
    }

    .campo:focus {
      border-color: #0056b3;
      outline: none;
      background: white;
      z-index: 100;
    }

    /* Responsividade para celular */
    @media (max-width: 768px) {
      body {
        padding: 5px;
      }
      
      .container {
        width: 100%;
        margin: 0;
        overflow-x: auto;
      }
      
      .campo {
        font-size: 10px;
        padding: 1px;
        min-height: 14px;
        min-width: 20px;
      }
      
      .campo[type="text"] {
        min-width: 40px;
      }
      
      .campo[type="checkbox"] {
        width: 10px;
        height: 10px;
        min-height: 10px;
        transform: scale(0.7);
      }
      
      .button-container {
        padding: 15px 10px !important;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      
      .pdf-button, .whatsapp-button, .print-button {
        width: 100%;
        min-width: auto;
        margin: 0;
        padding: 15px 20px;
        font-size: 16px;
      }
    }

    /* Para telas muito pequenas */
    @media (max-width: 480px) {
      .container {
        transform: scale(0.9);
        transform-origin: top left;
        width: 111%;
      }
      
      .campo {
        font-size: 9px;
        border-width: 1px;
      }
    }

    .button-container {
      text-align: center;
      margin-top: 20px;
      padding: 20px;
      background: white;
      width: 100%;
      clear: both;
      position: relative;
      z-index: 1000;
    }

    .pdf-button, .print-button {
      padding: 12px 24px;
      font-size: 16px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
      display: inline-block;
      min-width: 200px;
      margin: 5px;
    }

    .pdf-button:hover:not(:disabled), .print-button:hover:not(:disabled) {
      background: #0056b3;
    }

    .whatsapp-button {
      padding: 12px 24px;
      font-size: 16px;
      background: #25D366;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
      display: inline-block;
      min-width: 200px;
      margin: 5px;
    }

    .whatsapp-button:hover:not(:disabled) {
      background: #1DA851;
    }

    .whatsapp-button:disabled, .pdf-button:disabled, .print-button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    .print-button {
      background: #6c757d;
    }

    .print-button:hover:not(:disabled) {
      background: #5a6268;
    }

    /* Para garantir que tudo fique em uma p√°gina no PDF */
    @media print {
      body {
        margin: 0;
        padding: 0;
      }
      
      .container {
        page-break-inside: avoid;
        transform: scale(0.75);
        transform-origin: top left;
        box-shadow: none;
        width: 210mm;
        max-height: 297mm;
      }
      
      .button-container {
        display: none;
      }
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      font-size: 18px;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Overlay de loading -->
  <div class="loading-overlay" id="loadingOverlay">
    <div style="text-align: center;">
      <div class="spinner"></div>
      <div id="loadingText">Processando...</div>
    </div>
  </div>

  <div class="container" id="formulario-pdf">
    <img src="ordem-servico.JPG" alt="Imagem da Ordem de Servi√ßo" class="imagem-fundo" id="imagemOrdem">
    
    <!-- Campos sobrepostos -->
    <input type="text" class="campo" style="top: 283px; left: 588px; width: 260px;" placeholder="Nome do cliente" id="nomeCliente">
    <input type="text" class="campo" style="top: 313px; left: 695px; width: 120px;" placeholder="CPF" id="cpfCliente">
    
    <!-- Servi√ßos cancelados -->
    <input type="checkbox" class="campo" style="top: 382px; left: 220px;" id="servico1" title="TV por assinatura">
    <input type="checkbox" class="campo" style="top: 382px; left: 407px;" id="servico2" title="Ponto adicional TV">
    <input type="checkbox" class="campo" style="top: 382px; left: 574px;" id="servico3" title="Internet">
    <input type="checkbox" class="campo" style="top: 382px; left: 690px;" id="servico4" title="Telefonia">
    
    <!-- Equipamentos -->
    <input type="checkbox" class="campo" style="top: 492px; left: 185px;" id="equipONU" title="ONU">
    <input type="text" class="campo" style="top: 492px; left: 250px; width: 540px;" placeholder="MAC ONU" id="macONU">
    
    <input type="checkbox" class="campo" style="top: 537px; left: 246px;" id="equipReceptor" title="Receptores">
    <input type="text" class="campo" style="top: 537px; left: 310px; width: 480px;" placeholder="MAC Receptores" id="macReceptor">
    
    <input type="checkbox" class="campo" style="top: 598px; left: 215px;" id="equipRoteador" title="Roteador">
    <input type="text" class="campo" style="top: 598px; left: 280px; width: 510px;" placeholder="N/S Roteador" id="nsRoteador">
    
    <input type="checkbox" class="campo" style="top: 635px; left: 215px;" id="equipTelefone" title="Telefone">
    <input type="text" class="campo" style="top: 635px; left: 280px; width: 510px;" placeholder="N/S Telefone" id="nsTelefone">
    
    <!-- Os kits est√£o completos -->
    <input type="checkbox" class="campo" style="top: 670px; left: 363px;" id="kitsCompletos" title="Sim">
    <input type="checkbox" class="campo" style="top: 670px; left: 431px;" id="kitsIncompletos" title="N√£o">
    <input type="text" class="campo" style="top: 702px; left: 148px; width: 640px;" placeholder="Observa√ß√µes sobre os kits" id="obsKits">
    
    <!-- Os Equipamentos est√£o em bom estado de conserva√ß√£o -->
    <input type="checkbox" class="campo" style="top: 774px; left: 615px;" id="bomEstado" title="Sim">
    <input type="checkbox" class="campo" style="top: 774px; left: 683px;" id="mauEstado" title="N√£o">
    <input type="text" class="campo" style="top: 818px; left: 133px; width: 660px;" placeholder="Observa√ß√µes sobre estado dos equipamentos" id="obsEstado">
    
    <!-- Informa√ß√µes finais -->
    <input type="text" class="campo" style="top: 927px; left: 415px; width: 350px;" placeholder="Protocolo de atendimento" id="protocolo">
    <input type="text" class="campo" style="top: 983px; left: 382px; width: 380px;" placeholder="T√©cnico respons√°vel pelo recolhimento" id="tecnico">
    <input type="text" class="campo" style="top: 1042px; left: 415px; width: 350px;" placeholder="Respons√°vel pela devolu√ß√£o" id="responsavel">
    <input type="text" class="campo" style="top: 1099px; left: 436px; width: 300px;" placeholder="Grau de parentesco" id="parentesco">
    
    <!-- Local e data -->
    <input type="text" class="campo" style="top: 1159px; left: 248px; width: 100px;" placeholder="Cidade" id="cidade">
    <input type="text" class="campo" style="top: 1159px; left: 388px; width: 50px;" placeholder="Dia" id="dia">
    <input type="text" class="campo" style="top: 1159px; left: 516px; width: 120px;" placeholder="M√™s" id="mes">
    <input type="text" class="campo" style="top: 1159px; left: 678px; width: 80px;" placeholder="Ano" id="ano">
  </div>
  
  <!-- Bot√µes -->
  <div class="button-container">
    <button onclick="gerarPDF()" class="pdf-button" id="btnPDF">üìÑ Baixar como PDF</button>
    <button onclick="enviarWhatsApp()" class="whatsapp-button" id="btnWhatsApp">üì± Enviar WhatsApp</button>
    <button onclick="imprimirFormulario()" class="print-button" id="btnImprimir">üñ®Ô∏è Imprimir</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script>
    // Detectar se √© dispositivo m√≥vel
    function isMobile() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
             (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1); // iPad no Safari
    }

    // Detectar sistema operacional
    function getOS() {
      const userAgent = navigator.userAgent || navigator.vendor || window.opera;
      
      if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
        return 'iOS';
      }
      
      if (/android/i.test(userAgent)) {
        return 'Android';
      }
      
      return 'Other';
    }

    // Mostrar loading
    function showLoading(text = 'Processando...') {
      const overlay = document.getElementById('loadingOverlay');
      const loadingText = document.getElementById('loadingText');
      loadingText.textContent = text;
      overlay.style.display = 'flex';
    }

    // Esconder loading
    function hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      overlay.style.display = 'none';
    }

    // Ajustar para mobile quando carregar a p√°gina
    function ajustarParaMobile() {
      if (isMobile()) {
        const campos = document.querySelectorAll('.campo');
        
        // Melhorar visibilidade dos campos no mobile
        campos.forEach(campo => {
          campo.style.backgroundColor = 'rgba(255, 255, 255, 0.95)';
          campo.style.border = '2px solid #007bff';
          if (campo.type === 'text') {
            campo.style.minWidth = '60px';
          }

          // Adicionar evento de zoom nos campos para mobile
          campo.addEventListener('focus', function() {
            this.style.transform = 'scale(1.1)';
            this.style.zIndex = '1000';
            this.scrollIntoView({ behavior: 'smooth', block: 'center' });
          });
          
          campo.addEventListener('blur', function() {
            this.style.transform = '';
            this.style.zIndex = '';
          });
        });
      }
    }

    function prepararParaPDF() {
      const container = document.getElementById('formulario-pdf');
      const inputs = container.querySelectorAll('input');
      const substituidos = [];

      // Replace inputs with spans for PDF generation
      inputs.forEach(input => {
        const span = document.createElement('span');
        
        // Handle different input types
        if (input.type === 'checkbox') {
          span.textContent = input.checked ? '‚úì' : '‚òê';
          span.style.fontSize = '16px';
          span.style.fontWeight = 'bold';
          span.style.color = input.checked ? '#007bff' : '#ccc';
        } else {
          span.textContent = input.value || '_'.repeat(20);
          span.style.fontSize = '12px';
          span.style.fontWeight = 'bold';
        }
        
        // Copy all relevant styles
        span.style.position = 'absolute';
        span.style.top = input.style.top;
        span.style.left = input.style.left;
        span.style.width = input.style.width;
        span.style.color = span.style.color || '#000';
        span.style.fontFamily = 'Arial, sans-serif';
        span.style.padding = '2px';
        span.style.border = 'none';
        span.style.background = 'transparent';
        span.style.lineHeight = '1.2';
        span.style.display = 'inline-block';
        
        container.appendChild(span);
        substituidos.push({ original: input, substituto: span });
        input.style.display = 'none';
      });

      return substituidos;
    }

    function restaurarInputs(substituidos) {
      substituidos.forEach(({ original, substituto }) => {
        substituto.remove();
        original.style.display = '';
      });
    }

    function gerarPDF() {
      showLoading('Gerando PDF...');
      
      try {
        const container = document.getElementById('formulario-pdf');
        const substituidos = prepararParaPDF();

        // PDF generation options
        const opt = {
          margin: 10,
          filename: `ordem-servico-${new Date().toISOString().split('T')[0]}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { 
            scale: 2,
            useCORS: true,
            allowTaint: true,
            backgroundColor: '#ffffff',
            scrollX: 0,
            scrollY: 0,
            windowWidth: container.scrollWidth,
            windowHeight: container.scrollHeight
          },
          jsPDF: { 
            unit: 'mm', 
            format: 'a4', 
            orientation: 'portrait' 
          }
        };

        // Generate and download PDF
        html2pdf().set(opt).from(container).save()
          .then(() => {
            console.log('PDF gerado com sucesso!');
            hideLoading();
          })
          .catch((error) => {
            console.error('Erro ao gerar PDF:', error);
            alert('Erro ao gerar PDF. Tente novamente.');
            hideLoading();
          })
          .finally(() => {
            restaurarInputs(substituidos);
          });
      } catch (error) {
        console.error('Erro geral:', error);
        alert('Erro inesperado. Tente novamente.');
        hideLoading();
      }
    }

    function imprimirFormulario() {
      showLoading('Preparando para impress√£o...');
      
      const container = document.getElementById('formulario-pdf');
      const substituidos = prepararParaPDF();

      setTimeout(() => {
        hideLoading();
        window.print();
        
        setTimeout(() => {
          restaurarInputs(substituidos);
        }, 1000);
      }, 500);
    }

    function enviarWhatsApp() {
      showLoading('Preparando envio...');
      
      const nomeCliente = document.getElementById('nomeCliente').value || 'Cliente';
      const protocolo = document.getElementById('protocolo').value || 'N/A';
      const tecnico = document.getElementById('tecnico').value || 'N/A';
      
      const mensagem = encodeURIComponent(
        `üìã *Ordem de Servi√ßo Brisanet*\n\n` +
        `üë§ Cliente: ${nomeCliente}\n` +
        `üìÑ Protocolo: ${protocolo}\n` +
        `üë®‚Äçüîß T√©cnico: ${tecnico}\n` +
        `üìÖ Data: ${new Date().toLocaleDateString('pt-BR')}\n\n` +
        `‚úÖ Ordem de servi√ßo preenchida e pronta para envio.\n\n` +
        `*Brisanet - Conectando voc√™ ao futuro*`
      );

      // Fun√ß√£o para abrir WhatsApp
      function abrirWhatsApp() {
        const os = getOS();
        let whatsappURL;
        let fallbackURL;
        
        if (os === 'iOS') {
          // iOS - tentar app nativo primeiro
          whatsappURL = `whatsapp://send?text=${mensagem}`;
          fallbackURL = `https://wa.me/?text=${mensagem}`;
        } else if (os === 'Android') {
          // Android - tentar app nativo primeiro
          whatsappURL = `intent://send?text=${mensagem}#Intent;package=com.whatsapp;scheme=whatsapp;launchFlags=0x10000000;end`;
          fallbackURL = `https://wa.me/?text=${mensagem}`;
        } else {
          // Desktop ou outros - direto para WhatsApp Web
          whatsappURL = `https://web.whatsapp.com/send?text=${mensagem}`;
          fallbackURL = null;
        }

        // Tentar abrir o app nativo
        if (isMobile() && fallbackURL) {
          // Criar link invis√≠vel para tentar abrir o app
          const link = document.createElement('a');
          link.href = whatsappURL;
          link.style.display = 'none';
          document.body.appendChild(link);
          
          let appOpened = false;
          
          // Detectar se o app foi aberto
          const startTime = Date.now();
          
          // Tentar clicar no link
          link.click();
          
          // Fallback ap√≥s 2.5 segundos se o app n√£o abriu
          const fallbackTimer = setTimeout(() => {
            if (!appOpened && (Date.now() - startTime) < 3000) {
              console.log('App n√£o abriu, tentando fallback...');
              window.open(fallbackURL, '_blank');
            }
          }, 2500);
          
          // Detectar se a p√°gina perdeu foco (indica que app abriu)
          const onBlur = () => {
            appOpened = true;
            clearTimeout(fallbackTimer);
            window.removeEventListener('blur', onBlur);
          };
          
          const onFocus = () => {
            setTimeout(() => {
              if (!appOpened && (Date.now() - startTime) > 1000) {
                console.log('Voltou para p√°gina, tentando fallback...');
                window.open(fallbackURL, '_blank');
              }
            }, 100);
            window.removeEventListener('focus', onFocus);
          };
          
          window.addEventListener('blur', onBlur);
          window.addEventListener('focus', onFocus);
          
          // Limpar link ap√≥s 5 segundos
          setTimeout(() => {
            document.body.removeChild(link);
          }, 5000);
          
        } else {
          // Desktop ou fallback direto
          window.open(whatsappURL, '_blank');
        }
      }

      // Gerar PDF primeiro, depois abrir WhatsApp
      const container = document.getElementById('formulario-pdf');
      const substituidos = prepararParaPDF();

      const opt = {
        margin: 10,
        filename: `ordem-servico-${nomeCliente.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { 
          scale: 2,
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#ffffff'
        },
        jsPDF: { 
          unit: 'mm', 
          format: 'a4', 
          orientation: 'portrait' 
        }
      };

      html2pdf().set(opt).from(container).save()
        .then(() => {
          hideLoading();
          
          // Abrir WhatsApp ap√≥s pequeno delay
          setTimeout(() => {
            abrirWhatsApp();
          }, 500);
          
          // Instru√ß√µes para o usu√°rio
          setTimeout(() => {
            const os = getOS();
            let instrucao;
            
            if (os === 'iOS') {
              instrucao = 'üì± WhatsApp aberto no iOS!\n\n' +
                         '‚úÖ PDF baixado automaticamente\n' +
                         'üìé Anexe o arquivo PDF no chat\n' +
                         'üí° Mensagem j√° est√° pronta!';
            } else if (os === 'Android') {
              instrucao = 'üì± WhatsApp aberto no Android!\n\n' +
                         '‚úÖ PDF baixado automaticamente\n' +
                         'üìé Anexe o arquivo PDF no chat\n' +
                         'üí° Mensagem j√° est√° pronta!';
            } else {
              instrucao = 'üíª WhatsApp Web aberto!\n\n' +
                         '‚úÖ PDF baixado automaticamente\n' +
                         'üìé Anexe o arquivo PDF manualmente\n' +
                         'üí° Mensagem j√° est√° pronta!';
            }
            
            alert(instrucao);
          }, 1500);
        })
        .catch((error) => {
          console.error('Erro:', error);
          hideLoading();
          alert('Erro ao preparar envio. Tente novamente.');
        })
        .finally(() => {
          restaurarInputs(substituidos);
        });
    }

    // Auto-preencher data atual
    function preencherDataAtual() {
      const hoje = new Date();
      const dia = String(hoje.getDate()).padStart(2, '0');
      const meses = [
        'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
      ];
      const mes = meses[hoje.getMonth()];
      const ano = hoje.getFullYear();

      document.getElementById('dia').value = dia;
      document.getElementById('mes').value = mes;
      document.getElementById('ano').value = ano;
    }

    // Inicializar quando a p√°gina carregar
    document.addEventListener('DOMContentLoaded', function() {
      ajustarParaMobile();
      preencherDataAtual();
      
      // Verificar se o html2pdf foi carregado
      if (typeof html2pdf === 'undefined') {
        console.error('html2pdf n√£o foi carregado corretamente');
      }
    });
  </script>
</body>
</html>
